---
title: 小程序登陆
url: https://www.yuque.com/wcywxq/mxunh7/ykzhe6
---

<a name="afO2P"></a>

## 登陆流程

登录流程是调 `wx.login` 获取 `code` 传给后台服务器获取微信用户唯一标识 `openid` 及本次登录的会话密钥（`session_key`）等）。拿到开发者服务器传回来的会话密钥（`session_key`）之后，前端要保存 `wx.setStorageSync('sessionKey', 'value')`
持久登录状态：`session` 信息存放在 `cookie` 中以请求头的方式带回给服务端，放到 `request.js` 里的 `wx.request` 的 `header` 里 <a name="EWqSt"></a>

## UnionId 和 openId

- UnionId：是一个用户对于同主体微信小程序 、公众号、APP 的标识，开发者需要在微信开放平台下绑定相同账号的主体，开发者可通过 UnionId，实现多个小程序、公众号、甚至 APP 之间的数据互通
- openId：是一个用户对于一个小程序、公众号的标识，开发者可以通过这个标识识别出用户 <a name="NaQBj"></a>

## 关键 api

- wx.login：官方提供的登陆能力
- wx.checkSession：校验用户当前的 session\_key 是否有效
- wx.authorize：提前向用户发起授权请求
- wx.getUserInfo：获取用户基本信息 <a name="BmESV"></a>

## 登陆流程设计

<a name="AF1Zw"></a>

### 利用现有的登陆体系

直接复用现有系统的登陆体系，只需要在小程序端设计用户名，密码/验证码页面，便可以简便的实现登陆，只需要保持良好的用户体验即可 <a name="MHTIF"></a>

### 利用 OpenId 创建用户体系

OpenId 是一个小程序对于一个用户的标识，利用这一点我们可以轻松的实现一套基于小程序的用户体系，值得一题的是这种用户体系对用户的打扰最低，可以实现**静默登陆**，具体步骤如下：

- 小程序客户端通过 wx.login 获取 code
- 传递 code 向服务端，服务端拿到 code 调用微信登陆凭证校验接口，微信服务器返回 openId 和会话密钥 session\_key，此时开发者服务端便可以利用 openId 生成用户入库，再向小程序客户端返回自定义登陆态
- 小程序客户端缓存(通过 storage) 自定义登陆态(token)，后续调用接口时携带该登陆态作为用户身份标识即可 <a name="Kyq5g"></a>

### 利用 UnionId 创建用户体系

如果想实现多个小程序、公众号，已有登陆的数据互通，可以通过获取到用户 `unionId` 的方式建立用户体系。因为 `unionId` 在同一开放平台下的所有应用都是相同的，通过 `unionId` 简历的用户体系即可实现全平台数据的互通，更方便的接入原有的功能，使用 `unionId` 的获取有以下两种方式：

- 如果用户关注了某个相同主体公众号，或曾经在某个相同主题 App、公众号上进行过微信登陆授权，通过 wx.login 可以直接获取到 `unionId`
- 结合 `wx.getUserInfo` 和 `<button open-type="getUserInfo"></button>` 这两种方式引导用户主动授权，主动授权后通过返回的信息和服务端交互(这里有一步需要服务端解密数据的过程，很简单，微信提供了示例代码)即可拿到 `unionId` 建立用户体系，然后由服务端返回登陆态，本地记录即可实现登陆 <a name="ONzeU"></a>

#### 微信提供的最佳实践

- 调用 wx.login 获取 code，然后从微信后端换取到 session\_key，用于解密 getUserInfo 返回的敏感数据

- 使用 wx.getSetting 获取用户的授权情况
  - 如果用户已经授权，直接调用 API wx.getUserInfo 获取用户最新的信息
  - 用户未授权，在界面中显示一个按钮提示用户登入，当用户点击并授权后就获取到用户的最新信息

- 获取到用户数据后可以进行展示或者发送给自己的后端
  :::warning

- 需要获取 unionid 形式的登录体系，在以前（18年4月之前）是通过以下这种方式来实现，但后续微信做了调整（因为一进入小程序，主动弹起各种授权弹窗的这种形式，比较容易导致用户流失），调整为必须使用按钮引导用户主动授权的方式，这次调整对开发者影响较大，开发者需要注意遵守微信的规则，并及时和业务方沟通业务形式，不要存在侥幸心理，以防造成小程序不过审等情况

`wx.login(获取code) ===> wx.getUserInfo(用户授权) ===> 获取 unionid`

- 因为小程序不存在 `cookie` 的概念， 登录态必须缓存在本地，因此强烈建议为登录态设置过期时间
- 值得一提的是如果需要支持风控安全校验，多平台登录等功能，可能需要加入一些公共参数，例如 `platform`，`channel`，`deviceParam` 等参数。在和服务端确定方案时，作为前端同学应该及时提出这些合理的建议，设计合理的系统。
- `openid`, `unionid` 不要在接口中明文传输，这是一种危险的行为，同时也很不专业
  :::
